# 先在这个工程下做测试，创建 client 测试程序

dotnet new console -n Client
dotnet add package DnsClient

#

## userapi 工程 天剑 nuget 包

dotnet add package Consul

# 注册服务到 consul 遇到的问题

HostedService

原始方式（已移除）：

```
builder.Services.AddSingleton<ConsulRegistrationService>();
builder.Services.AddSingleton<IHostedService>(provider =>
    provider.GetRequiredService<ConsulRegistrationService>());

```

这种方式：

1. 将 ConsulRegistrationService 同时注册为 IHostedService

2. 框架会自动调用其 StartAsync() 和 StopAsync() 方法

3. 但在服务器完全启动前执行，导致无法获取地址

新方式：

```
// 使用应用生命周期事件触发注册
var lifetime = app.Services.GetRequiredService<IHostApplicationLifetime>();
var consulService = app.Services.GetRequiredService<ConsulRegistrationService>();

lifetime.ApplicationStarted.Register(async () =>
{
    try
    {
        await consulService.RegisterAsync(lifetime.ApplicationStopping);
    }
    catch (Exception ex)
    {
        var logger = app.Services.GetRequiredService<ILogger<Program>>();
        logger.LogError(ex, "Consul 注册失败");
    }
});

lifetime.ApplicationStopping.Register(async () =>
{
    try
    {
        await consulService.DeregisterAsync(lifetime.ApplicationStopping);
    }
    catch (Exception ex)
    {
        var logger = app.Services.GetRequiredService<ILogger<Program>>();
        logger.LogError(ex, "Consul 注销失败");
    }
});

```

# 在此测试 api1 ， api2 测试程序中应用就是 IHostedService 方法，是因为这里没有去获取服务启动 Url 的逻辑，所以没有问题
